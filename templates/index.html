<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Content Extractor</title>
    <!-- Modular CSS files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/modals.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/tables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/files.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/fact-matrix.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/timeline.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/liability.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/rationale.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/utilities.css') }}">
    <!-- Legacy style.css - will be removed after testing -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header class="main-header">
            <div class="header-left">
                <h1 class="ava-brand">ava</h1>
            </div>
            <div class="step-indicators">
                <div class="step-item completed" data-step="files" onclick="switchTab('files')">
                    <span class="step-label">Review</span>
                </div>
                <div class="step-item" data-step="fact-matrix" onclick="switchTab('fact-matrix')">
                    <span class="step-label">Fact Matrix</span>
                </div>
                <div class="step-item locked" data-step="timeline" onclick="switchTab('timeline')">
                    <span class="step-label">Timeline Reconstruction</span>
                </div>
                <div class="step-item locked" data-step="liability-recommendation" onclick="switchTab('liability-recommendation')">
                    <span class="step-label">Liability % Recommendation</span>
                </div>
                <div class="step-item locked" data-step="claim-rationale" onclick="switchTab('claim-rationale')">
                    <span class="step-label">Draft Claim Rationale</span>
                </div>
            </div>
            <div class="header-right">
                <div class="user-menu">
                    <button class="logout-button" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="main-layout">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <div class="claimant-contact">
                    <h3>Claimant Contact</h3>
                    <div class="contact-item">
                        <svg class="contact-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M2 4L8 8L14 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <rect x="2" y="3" width="12" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <span>john.anderson@email.com</span>
                    </div>
                    <div class="contact-item">
                        <svg class="contact-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M3.5 2C2.67157 2 2 2.67157 2 3.5V12.5C2 13.3284 2.67157 14 3.5 14H5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M10.5 2H12.5C13.3284 2 14 2.67157 14 3.5V12.5C14 13.3284 13.3284 14 12.5 14H10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6 4H10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>(555) 123-4567</span>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
        <div class="files-section" id="filesSection">
            <div class="content-section">
                <!-- Files Tab -->
                <div class="tab-content active" id="filesTab">
                    <div class="file-list-container" id="fileListContainer">
                        <div class="file-list-header">
                            <h2>Claim Documents</h2>
                            <div class="header-actions">
                                <button class="small-upload-button" id="smallUploadButton" onclick="triggerBulkUpload()" title="Upload Files">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    <span>Upload</span>
                                </button>
                            </div>
                        </div>
                        <div id="bulkUploadProgress" style="display: none; margin-top: 20px;">
                            <div class="bulk-upload-status" id="bulkUploadStatus"></div>
                        </div>
                        <div class="tab-loading" id="fileListLoading" style="display: none;">
                            <div class="spinner"></div>
                            <p>Loading documents...</p>
                        </div>
                        <div class="file-list" id="fileList">
                            <!-- File list items will be generated by JavaScript -->
                        </div>
                        
                        <!-- Evidence Completeness Section -->
                        <div id="evidenceCompletenessSection" style="display: block; margin-top: 30px; padding-top: 30px; border-top: 1px solid #e0e0e0;">
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #333; font-size: 1.2em;">Evidence Completeness</h3>
                            </div>
                            
                            <div class="tab-loading" id="evidenceCompletenessLoading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Checking evidence completeness...</p>
                            </div>
                            
                            <!-- Checks Summary Section -->
                            <div class="checks-summary-section" id="checksSummarySection" style="display: none;">
                                <h4 style="margin-bottom: 15px; color: #666; font-size: 1em;">Completeness Checks</h4>
                                <div class="evidence-completeness-table-container">
                                    <table class="evidence-completeness-table" id="checksTable">
                                        <thead>
                                            <tr>
                                                <th>Evidence Type</th>
                                                <th>Status</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody id="checksTableBody">
                                            <!-- Checks will be rendered here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div style="margin-top: 20px;">
                                    <button class="summary-button" id="requestMoreDetailsButton" onclick="openEmailRequestModal()" style="display: none;">
                                        Request More Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="file-content-view" id="fileContentView" style="display: none;">
                        <div class="file-content-header">
                            <button class="back-button" onclick="showFileList()">
                                <span class="back-icon">‚Üê</span>
                                <span>Back to Files</span>
                            </button>
                        </div>
                        <div class="metadata" id="metadata"></div>
                        <div class="pages" id="pages"></div>
                    </div>
                </div>
                
                <!-- Fact Matrix Tab -->
                <div class="tab-content" id="factMatrixTab" style="display: none;">
                    <div class="fact-matrix-view" id="factMatrixView">
                        <div class="fact-matrix-header">
                            <h2>Fact Matrix & Liability Signals</h2>
                        </div>
                    
                    <div class="fact-matrix-controls">
                        <div class="filter-group">
                            <label for="categoryFilter">Category:</label>
                            <select id="categoryFilter" onchange="filterFacts()">
                                <option value="">All Categories</option>
                                <option value="movement">Movement</option>
                                <option value="environment">Environment</option>
                                <option value="compliance">Compliance</option>
                                <option value="impact">Impact</option>
                                <option value="location">Location</option>
                                <option value="temporal">Temporal</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="sourceFilter">Source:</label>
                            <select id="sourceFilter" onchange="filterFacts()">
                                <option value="">All Sources</option>
                                <option value="fnol">FNOL</option>
                                <option value="claimant">Claimant</option>
                                <option value="other_driver">Other Driver</option>
                                <option value="police">Police</option>
                                <option value="repair_estimate">Repair Estimate</option>
                                <option value="policy">Policy</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="searchFilter">Search:</label>
                            <input type="text" id="searchFilter" placeholder="Search facts..." oninput="filterFacts()">
                        </div>
                        <div class="filter-group">
                            <label for="sortBy">Sort by:</label>
                            <select id="sortBy" onchange="filterFacts()">
                                <option value="confidence">Confidence (High to Low)</option>
                                <option value="confidence-asc">Confidence (Low to High)</option>
                                <option value="category">Category</option>
                                <option value="source">Source</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="fact-matrix-split-container" id="factMatrixSplitContainer">
                        <div class="fact-matrix-content">
                            <div class="fact-table-container">
                                <table class="fact-table" id="factTable">
                                    <thead>
                                        <tr>
                                            <th>Fact #</th>
                                            <th>Source Text</th>
                                            <th>Extracted Fact</th>
                                            <th>Category</th>
                                            <th>Source</th>
                                            <th>Conflict</th>
                                            <th>Signal Type</th>
                                            <th>Impact on Liability</th>
                                            <th>Severity</th>
                                        </tr>
                                    </thead>
                                    <tbody id="factTableBody">
                                        <!-- Facts will be rendered here -->
                                    </tbody>
                                </table>
                                <div class="tab-loading" id="factMatrixLoading" style="display: none;">
                                    <div class="spinner"></div>
                                    <p>Processing...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accepted-decisions-section" id="acceptedDecisionsSection" style="display: none;">
                        <h3>Accepted Decisions</h3>
                        <div class="accepted-decisions-table-container">
                            <table class="accepted-decisions-table" id="acceptedDecisionsTable">
                                <thead>
                                    <tr>
                                        <th>Conflict Description</th>
                                        <th>Accepted Value</th>
                                        <th>Resolved</th>
                                    </tr>
                                </thead>
                                <tbody id="acceptedDecisionsTableBody">
                                    <!-- Accepted decisions will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </div>
                
                
                <!-- Liability Recommendation Tab -->
                <div class="tab-content" id="liabilityRecommendationTab" style="display: none;">
                    <div class="liability-recommendation-view" id="liabilityRecommendationView">
                        <div class="liability-recommendation-header">
                            <h2>Liability % Recommendation</h2>
                        </div>
                    
                        <div class="liability-recommendation-content">
                            <div class="tab-loading" id="liabilityRecommendationLoading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Processing...</p>
                            </div>
                            <div class="recommendation-form" id="recommendationForm" style="display: none;">
                                <div class="recommendation-percentages">
                                    <div class="percentage-input-group">
                                        <label for="claimantLiabilityPercent">Claimant Liability:</label>
                                        <div class="percentage-input-container">
                                            <input type="number" id="claimantLiabilityPercent" min="0" max="100" value="0" onchange="updateLiabilityPercentages()">
                                            <span class="percentage-symbol">%</span>
                                        </div>
                                    </div>
                                    <div class="percentage-input-group">
                                        <label for="otherDriverLiabilityPercent">Other Driver Liability:</label>
                                        <div class="percentage-input-container">
                                            <input type="number" id="otherDriverLiabilityPercent" min="0" max="100" value="0" onchange="updateLiabilityPercentages()">
                                            <span class="percentage-symbol">%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="recommendation-explanation">
                                    <label for="recommendationExplanation">Explanation:</label>
                                    <textarea id="recommendationExplanation" rows="10" placeholder="Explanation will appear here..."></textarea>
                                </div>
                                
                                <div class="recommendation-details">
                                    <div class="key-factors-section">
                                        <h3>Key Factors</h3>
                                        <ul id="keyFactorsList">
                                            <!-- Key factors will be rendered here -->
                                        </ul>
                                    </div>
                                    
                                    <div class="confidence-section">
                                        <h3>Confidence</h3>
                                        <div class="confidence-display">
                                            <div class="confidence-bar">
                                                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                                            </div>
                                            <span class="confidence-text" id="confidenceText">0%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="recommendation-actions">
                                    <button class="update-button" onclick="updateLiabilityRecommendation()">
                                        Update Recommendation
                                    </button>
                                </div>
                            </div>
                            
                            <div class="empty-state-container" id="recommendationEmptyState">
                                <p class="empty-state">Extract facts and analyze liability signals first, then click "Get Recommendation" to generate a liability percentage recommendation.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline Reconstruction Tab -->
                <div class="tab-content" id="timelineTab" style="display: none;">
                    <div class="timeline-view" id="timelineView">
                        <div class="timeline-header">
                            <h2>Timeline Reconstruction</h2>
                        </div>
                    
                        <div class="timeline-content">
                            <div class="tab-loading" id="timelineLoading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Processing...</p>
                            </div>
                            <div class="timeline-events-container" id="timelineEventsContainer" style="display: none;">
                                <ol class="timeline-events-list" id="timelineEventsList">
                                    <!-- Timeline events will be rendered here -->
                                </ol>
                                <div class="timeline-actions" style="margin-top: 30px; display: flex; justify-content: flex-end;">
                                    <button class="summary-button" id="saveTimelineButton" onclick="saveTimeline()" style="display: none;">
                                        Save Timeline
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Draft Claim Rationale Tab -->
                <div class="tab-content" id="claimRationaleTab" style="display: none;">
                    <div class="claim-rationale-view" id="claimRationaleView">
                        <div class="claim-rationale-header">
                            <h2>Draft Claim File Rationale</h2>
                            <div class="claim-rationale-actions">
                                <button class="summary-button" id="editRationaleButton" onclick="toggleEditRationale()" style="display: none;">
                                    Edit
                                </button>
                                <button class="summary-button" id="saveRationaleButton" onclick="saveEditedRationale()" style="display: none;">
                                    Save
                                </button>
                                <button class="summary-button" id="cancelEditRationaleButton" onclick="cancelEditRationale()" style="display: none;">
                                    Cancel
                                </button>
                                <button class="summary-button" id="supervisorEscalationButton" onclick="openSupervisorEscalationModal()" style="display: none;">
                                    Supervisor Escalation
                                </button>
                                <button class="summary-button" id="downloadRationaleButton" onclick="downloadClaimRationalePDF()" style="display: none;">
                                    Download
                                </button>
                            </div>
                        </div>
                    
                        <div class="claim-rationale-content">
                            <div class="tab-loading" id="claimRationaleLoading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Generating claim rationale...</p>
                            </div>
                            <div class="rationale-display" id="rationaleDisplay" style="display: none;">
                                <!-- Rationale will be displayed here -->
                            </div>
                            <div class="rationale-edit" id="rationaleEdit" style="display: none;">
                                <!-- Editable rationale will be displayed here -->
                            </div>
                            
                            <div class="empty-state-container" id="rationaleEmptyState">
                                <p class="empty-state">Extract facts and analyze liability signals first, then click "Generate Rationale" to create an audit-ready adjuster narrative.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="navigation-buttons">
                    <button class="nav-button prev-button" id="prevButton" onclick="goToPreviousStep()">
                        Previous
                    </button>
                    <button class="nav-button next-button" id="nextButton" onclick="goToNextStep()">
                        Next
                    </button>
                </div>
            </div>
        </div>
            </main>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
        </div>

        <div class="error" id="error" style="display: none;"></div>
        
        <!-- Hidden file input for uploads -->
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.mp3,.wav,.m4a,.mp4,.mpeg,.mpga,.webm,.ogg" hidden>
        <input type="file" id="bulkFileInput" accept=".pdf,.jpg,.jpeg,.png,.mp3,.wav,.m4a,.mp4,.mpeg,.mpga,.webm,.ogg" multiple hidden>
        
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflictModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Resolve Conflict</h3>
                <span class="modal-close" onclick="closeConflictModal()">&times;</span>
            </div>
            <div class="modal-body" id="conflictModalBody">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Supervisor Escalation Modal -->
    <div id="supervisorEscalationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Supervisor Escalation Package</h3>
                <span class="modal-close" onclick="closeSupervisorEscalationModal()">&times;</span>
            </div>
            <div class="modal-body" id="supervisorEscalationModalBody">
                <div class="tab-loading" id="escalationModalLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating escalation package...</p>
                </div>
                <div id="escalationModalContent" style="display: none;">
                    <!-- Escalation package content will be populated here -->
                </div>
            </div>
            <div class="modal-actions" id="supervisorEscalationModalActions" style="display: none;">
                <button class="modal-button modal-button-secondary" onclick="closeSupervisorEscalationModal()">Cancel</button>
                <button class="modal-button modal-button-primary" onclick="sendToSupervisor()">Send to Supervisor</button>
            </div>
        </div>
    </div>

    <!-- File View Modal -->
    <div id="fileViewModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="fileViewModalTitle">File Content</h3>
                <span class="modal-close" onclick="closeFileViewModal()">&times;</span>
            </div>
            <div class="modal-body" id="fileViewModalBody">
                <!-- File content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Email Request Modal -->
    <div id="emailRequestModal" class="modal" style="display: none;">
        <div class="modal-content email-request-modal" style="max-width: 1000px; max-height: 90vh;">
            <div class="modal-header">
                <h3>Request More Details</h3>
                <span class="modal-close" onclick="closeEmailRequestModal()">&times;</span>
            </div>
            <div class="modal-body email-request-modal-body">
                <div class="email-request-layout">
                    <!-- Left Column -->
                    <div class="email-request-left">
                        <!-- Upper Half: Missing Evidence Selection -->
                        <div class="email-request-section">
                            <h4>Select Missing Evidence</h4>
                            <div id="missingEvidenceList" class="missing-evidence-list">
                                <!-- Missing evidence checkboxes will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Lower Half: Contact Selection -->
                        <div class="email-request-section">
                            <h4>Select Contact</h4>
                            <div class="contact-selection">
                                <select id="contactSelect" class="contact-dropdown" onchange="onContactChange()">
                                    <option value="">Select a contact...</option>
                                </select>
                                <button type="button" class="add-contact-button" onclick="showAddContactForm()">+ Add Contact</button>
                                <div id="addContactForm" class="add-contact-form" style="display: none;">
                                    <div class="contact-input-row">
                                        <input type="text" id="newContactName" placeholder="Name" class="contact-input">
                                        <input type="email" id="newContactEmail" placeholder="Email" class="contact-input">
                                    </div>
                                    <input type="text" id="newContactRole" placeholder="Role (optional)" class="contact-input">
                                    <div class="add-contact-actions">
                                        <button type="button" class="modal-button modal-button-primary" onclick="addContact()">Add</button>
                                        <button type="button" class="modal-button modal-button-secondary" onclick="hideAddContactForm()">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Email Draft -->
                    <div class="email-request-right">
                        <div class="email-request-section">
                            <h4>Email Draft</h4>
                            <div class="email-draft-container">
                                <div class="tab-loading" id="emailDraftLoading" style="display: none;">
                                    <div class="spinner"></div>
                                    <p>Generating email draft...</p>
                                </div>
                                <textarea id="emailDraftTextarea" class="email-draft-textarea" rows="15" placeholder="Select missing evidence and a contact, then click 'Generate Draft' to create an email draft."></textarea>
                                <button type="button" id="generateDraftButton" class="generate-draft-button" onclick="generateEmailDraft()" style="margin-top: 10px;">Generate Draft</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-button modal-button-secondary" onclick="closeEmailRequestModal()">Close</button>
                <button class="modal-button modal-button-primary" onclick="sendEmailRequest()">Send Email</button>
            </div>
        </div>
    </div>

    <!-- Legacy script.js - will be removed after full migration -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <!-- New modular structure -->
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>

