<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Content Extractor</title>
    <!-- Modular CSS files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/modals.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/tables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/files.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/fact-matrix.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/timeline.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/liability.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/views/rationale.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/utilities.css') }}">
    <!-- Legacy style.css - will be removed after testing -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>AVA</h1>
            <p>Automated Vehicle Adjudicator</p>
        </header>

        <div class="files-section" id="filesSection">
            <!-- Step Progress Indicator -->
            <div class="step-progress-container">
                <!-- Segmented Progress Bar - ABOVE step indicators -->
                <div class="segmented-progress-bar" id="segmentedProgressBar">
                <div class="progress-segment" data-step-index="0"></div>
                <div class="progress-segment" data-step-index="1"></div>
                <div class="progress-segment" data-step-index="2"></div>
                <div class="progress-segment" data-step-index="3"></div>
                <div class="progress-segment" data-step-index="4"></div>
                <div class="progress-segment" data-step-index="5"></div>
                </div>
                
                <!-- Step Indicators - BELOW progress bar -->
                <div class="step-indicators">
                    <div class="step-item completed" data-step="files" onclick="switchTab('files')">
                        <div class="step-icon">
                            <!-- Files icon -->
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5.83333 3.33333H11.6667L14.1667 5.83333V16.6667H5.83333V3.33333Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M11.6667 3.33333V5.83333H14.1667" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="step-label">Files</span>
                    </div>
                    <div class="step-item" data-step="fact-matrix" onclick="switchTab('fact-matrix')">
                        <div class="step-icon">
                            <!-- Fact Matrix / Grid icon -->
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M3.33333 3.33333H8.33333V8.33333H3.33333V3.33333Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M11.6667 3.33333H16.6667V8.33333H11.6667V3.33333Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M3.33333 11.6667H8.33333V16.6667H3.33333V11.6667Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M11.6667 11.6667H16.6667V16.6667H11.6667V11.6667Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="step-label">Fact Matrix</span>
                    </div>
                    <div class="step-item locked" data-step="timeline" onclick="switchTab('timeline')">
                        <div class="step-icon">
                            <!-- Timeline Reconstruction / Clock icon -->
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <circle cx="10" cy="10" r="7.5" stroke="currentColor" stroke-width="2"/>
                                <path d="M10 5V10L13.3333 13.3333" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="step-label">Timeline Reconstruction</span>
                    </div>
                    <div class="step-item locked" data-step="liability-recommendation" onclick="switchTab('liability-recommendation')">
                        <div class="step-icon">
                            <!-- Liability % Recommendation / Percentage icon -->
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M10 3.33333C6.31814 3.33333 3.33333 6.31814 3.33333 10C3.33333 13.6819 6.31814 16.6667 10 16.6667C13.6819 16.6667 16.6667 13.6819 16.6667 10C16.6667 6.31814 13.6819 3.33333 10 3.33333Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10 6.66667V10L12.5 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7.5 7.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M7.5 12.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <span class="step-label">Liability % Recommendation</span>
                    </div>
                    <div class="step-item locked" data-step="claim-rationale" onclick="switchTab('claim-rationale')">
                        <div class="step-icon">
                            <!-- Draft Claim Rationale / Document edit icon -->
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 5H15V15H5V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7.5 7.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M7.5 10H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M7.5 12.5H10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M12.5 7.5L15 10L12.5 12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <span class="step-label">Draft Claim Rationale</span>
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                <!-- Files Tab -->
                <div class="tab-content active" id="filesTab">
                    <div class="file-list-container" id="fileListContainer">
                        <div class="file-list-header">
                            <h2>Claim Documents</h2>
                            <div class="header-actions">
                            </div>
                        </div>
                        <div class="upload-section-main">
                            <button class="big-upload-button" id="bigUploadButton" onclick="triggerBulkUpload()">
                                <span class="upload-icon">üìÅ</span>
                                <span class="upload-text">Upload Files</span>
                                <span class="upload-subtext">Select multiple files to upload at once</span>
                            </button>
                            <p style="text-align: center; margin-top: 12px; color: #666; font-size: 0.9em;">
                                Supported formats: PDF, PNG, JPEG, JPG, Audio (MP3, WAV, M4A, etc.)
                            </p>
                        </div>
                        <div id="bulkUploadProgress" style="display: none; margin-top: 20px;">
                            <div class="bulk-upload-status" id="bulkUploadStatus"></div>
                        </div>
                        <div class="file-list" id="fileList">
                            <!-- File list items will be generated by JavaScript -->
                        </div>
                        
                        <!-- Evidence Completeness Section -->
                        <div id="evidenceCompletenessSection" style="display: none; margin-top: 30px; padding-top: 30px; border-top: 1px solid #e0e0e0;">
                            <h3 style="margin-bottom: 20px; color: #333; font-size: 1.2em;">Evidence Completeness</h3>
                            
                            <div class="tab-loading" id="evidenceCompletenessLoading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Checking evidence completeness...</p>
                            </div>
                            
                            <!-- Checks Summary Section -->
                            <div class="checks-summary-section" id="checksSummarySection" style="display: none;">
                                <h4 style="margin-bottom: 15px; color: #666; font-size: 1em;">Completeness Checks</h4>
                                <div class="checks-grid" id="checksGrid">
                                    <!-- Checks will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="file-content-view" id="fileContentView" style="display: none;">
                        <div class="file-content-header">
                            <button class="back-button" onclick="showFileList()">
                                <span class="back-icon">‚Üê</span>
                                <span>Back to Files</span>
                            </button>
                        </div>
                        <div class="metadata" id="metadata"></div>
                        <div class="pages" id="pages"></div>
                    </div>
                </div>
                
                <!-- Fact Matrix Tab -->
                <div class="tab-content" id="factMatrixTab" style="display: none;">
                    <div class="fact-matrix-view" id="factMatrixView">
                        <div class="fact-matrix-header">
                            <h2>Fact Matrix & Liability Signals</h2>
                        </div>
                    
                    <div class="fact-matrix-controls">
                        <div class="filter-group">
                            <label for="categoryFilter">Category:</label>
                            <select id="categoryFilter" onchange="filterFacts()">
                                <option value="">All Categories</option>
                                <option value="movement">Movement</option>
                                <option value="environment">Environment</option>
                                <option value="compliance">Compliance</option>
                                <option value="impact">Impact</option>
                                <option value="location">Location</option>
                                <option value="temporal">Temporal</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="sourceFilter">Source:</label>
                            <select id="sourceFilter" onchange="filterFacts()">
                                <option value="">All Sources</option>
                                <option value="fnol">FNOL</option>
                                <option value="claimant">Claimant</option>
                                <option value="other_driver">Other Driver</option>
                                <option value="police">Police</option>
                                <option value="repair_estimate">Repair Estimate</option>
                                <option value="policy">Policy</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="searchFilter">Search:</label>
                            <input type="text" id="searchFilter" placeholder="Search facts..." oninput="filterFacts()">
                        </div>
                        <div class="filter-group">
                            <label for="sortBy">Sort by:</label>
                            <select id="sortBy" onchange="filterFacts()">
                                <option value="confidence">Confidence (High to Low)</option>
                                <option value="confidence-asc">Confidence (Low to High)</option>
                                <option value="category">Category</option>
                                <option value="source">Source</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="fact-matrix-split-container" id="factMatrixSplitContainer">
                        <div class="fact-matrix-content">
                            <div class="fact-table-container">
                                <table class="fact-table" id="factTable">
                                    <thead>
                                        <tr>
                                            <th>Fact #</th>
                                            <th>Source Text</th>
                                            <th>Extracted Fact</th>
                                            <th>Category</th>
                                            <th>Source</th>
                                            <th>Conflict</th>
                                            <th>Signal Type</th>
                                            <th>Impact on Liability</th>
                                            <th>Severity</th>
                                        </tr>
                                    </thead>
                                    <tbody id="factTableBody">
                                        <!-- Facts will be rendered here -->
                                    </tbody>
                                </table>
                                <div class="tab-loading" id="factMatrixLoading" style="display: none;">
                                    <div class="spinner"></div>
                                    <p>Processing...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accepted-decisions-section" id="acceptedDecisionsSection" style="display: none;">
                        <h3>Accepted Decisions</h3>
                        <div class="accepted-decisions-table-container">
                            <table class="accepted-decisions-table" id="acceptedDecisionsTable">
                                <thead>
                                    <tr>
                                        <th>Conflict Description</th>
                                        <th>Accepted Value</th>
                                        <th>Resolved</th>
                                    </tr>
                                </thead>
                                <tbody id="acceptedDecisionsTableBody">
                                    <!-- Accepted decisions will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </div>
                
                
                <!-- Liability Recommendation Tab -->
                <div class="tab-content" id="liabilityRecommendationTab" style="display: none;">
                    <div class="liability-recommendation-view" id="liabilityRecommendationView">
                        <div class="liability-recommendation-header">
                            <h2>Liability % Recommendation</h2>
                        </div>
                    
                        <div class="liability-recommendation-content">
                            <div class="tab-loading" id="liabilityRecommendationLoading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Processing...</p>
                            </div>
                            <div class="recommendation-form" id="recommendationForm" style="display: none;">
                                <div class="recommendation-percentages">
                                    <div class="percentage-input-group">
                                        <label for="claimantLiabilityPercent">Claimant Liability:</label>
                                        <div class="percentage-input-container">
                                            <input type="number" id="claimantLiabilityPercent" min="0" max="100" value="0" onchange="updateLiabilityPercentages()">
                                            <span class="percentage-symbol">%</span>
                                        </div>
                                    </div>
                                    <div class="percentage-input-group">
                                        <label for="otherDriverLiabilityPercent">Other Driver Liability:</label>
                                        <div class="percentage-input-container">
                                            <input type="number" id="otherDriverLiabilityPercent" min="0" max="100" value="0" onchange="updateLiabilityPercentages()">
                                            <span class="percentage-symbol">%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="recommendation-explanation">
                                    <label for="recommendationExplanation">Explanation:</label>
                                    <textarea id="recommendationExplanation" rows="10" placeholder="Explanation will appear here..."></textarea>
                                </div>
                                
                                <div class="recommendation-details">
                                    <div class="key-factors-section">
                                        <h3>Key Factors</h3>
                                        <ul id="keyFactorsList">
                                            <!-- Key factors will be rendered here -->
                                        </ul>
                                    </div>
                                    
                                    <div class="confidence-section">
                                        <h3>Confidence</h3>
                                        <div class="confidence-display">
                                            <div class="confidence-bar">
                                                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                                            </div>
                                            <span class="confidence-text" id="confidenceText">0%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="recommendation-actions">
                                    <button class="update-button" onclick="updateLiabilityRecommendation()">
                                        Update Recommendation
                                    </button>
                                </div>
                            </div>
                            
                            <div class="empty-state-container" id="recommendationEmptyState">
                                <p class="empty-state">Extract facts and analyze liability signals first, then click "Get Recommendation" to generate a liability percentage recommendation.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline Reconstruction Tab -->
                <div class="tab-content" id="timelineTab" style="display: none;">
                    <div class="timeline-view" id="timelineView">
                        <div class="timeline-header">
                            <h2>Timeline Reconstruction</h2>
                            <div class="timeline-header-actions">
                                <button class="summary-button" id="saveTimelineButton" onclick="saveTimeline()" style="display: none;">
                                    Save Timeline
                                </button>
                            </div>
                        </div>
                    
                        <div class="timeline-content">
                            <div class="tab-loading" id="timelineLoading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Processing...</p>
                            </div>
                            <div class="timeline-events-container" id="timelineEventsContainer" style="display: none;">
                                <ol class="timeline-events-list" id="timelineEventsList">
                                    <!-- Timeline events will be rendered here -->
                                </ol>
                            </div>
                            
                            <div class="empty-state-container" id="timelineEmptyState">
                                <p class="empty-state">No timeline has been generated yet. Click the button below to generate a timeline reconstruction from the extracted facts.</p>
                                <button class="summary-button" id="generateTimelineButton" onclick="generateTimeline()" style="margin-top: 20px;">
                                    Generate Timeline
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Draft Claim Rationale Tab -->
                <div class="tab-content" id="claimRationaleTab" style="display: none;">
                    <div class="claim-rationale-view" id="claimRationaleView">
                        <div class="claim-rationale-header">
                            <h2>Draft Claim File Rationale</h2>
                            <div class="claim-rationale-actions">
                                <button class="summary-button" id="editRationaleButton" onclick="toggleEditRationale()" style="display: none;">
                                    Edit
                                </button>
                                <button class="summary-button" id="saveRationaleButton" onclick="saveEditedRationale()" style="display: none;">
                                    Save
                                </button>
                                <button class="summary-button" id="cancelEditRationaleButton" onclick="cancelEditRationale()" style="display: none;">
                                    Cancel
                                </button>
                                <button class="summary-button" id="supervisorEscalationButton" onclick="openSupervisorEscalationModal()" style="display: none;">
                                    Supervisor Escalation
                                </button>
                                <button class="summary-button" id="downloadRationaleButton" onclick="downloadClaimRationalePDF()" style="display: none;">
                                    Download
                                </button>
                            </div>
                        </div>
                    
                        <div class="claim-rationale-content">
                            <div class="rationale-display" id="rationaleDisplay" style="display: none;">
                                <!-- Rationale will be displayed here -->
                            </div>
                            <div class="rationale-edit" id="rationaleEdit" style="display: none;">
                                <!-- Editable rationale will be displayed here -->
                            </div>
                            
                            <div class="empty-state-container" id="rationaleEmptyState">
                                <p class="empty-state">Extract facts and analyze liability signals first, then click "Generate Rationale" to create an audit-ready adjuster narrative.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="navigation-buttons">
                    <button class="nav-button prev-button" id="prevButton" onclick="goToPreviousStep()">
                        Previous
                    </button>
                    <button class="nav-button next-button" id="nextButton" onclick="goToNextStep()">
                        Next
                    </button>
                </div>
            </div>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
        </div>

        <div class="error" id="error" style="display: none;"></div>
        
        <!-- Hidden file input for uploads -->
        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.mp3,.wav,.m4a,.mp4,.mpeg,.mpga,.webm,.ogg" hidden>
        <input type="file" id="bulkFileInput" accept=".pdf,.jpg,.jpeg,.png,.mp3,.wav,.m4a,.mp4,.mpeg,.mpga,.webm,.ogg" multiple hidden>
        
        <!-- Floating Upload Button - Always Visible -->
        <button class="floating-upload-button" id="floatingUploadButton" onclick="triggerBulkUpload()" title="Upload Files">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        </button>
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflictModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Resolve Conflict</h3>
                <span class="modal-close" onclick="closeConflictModal()">&times;</span>
            </div>
            <div class="modal-body" id="conflictModalBody">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Supervisor Escalation Modal -->
    <div id="supervisorEscalationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Supervisor Escalation Package</h3>
                <span class="modal-close" onclick="closeSupervisorEscalationModal()">&times;</span>
            </div>
            <div class="modal-body" id="supervisorEscalationModalBody">
                <div class="tab-loading" id="escalationModalLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating escalation package...</p>
                </div>
                <div id="escalationModalContent" style="display: none;">
                    <!-- Escalation package content will be populated here -->
                </div>
            </div>
            <div class="modal-actions" id="supervisorEscalationModalActions" style="display: none;">
                <button class="modal-button modal-button-secondary" onclick="closeSupervisorEscalationModal()">Cancel</button>
                <button class="modal-button modal-button-primary" onclick="sendToSupervisor()">Send to Supervisor</button>
            </div>
        </div>
    </div>

    <!-- Legacy script.js - will be removed after full migration -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <!-- New modular structure -->
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>

